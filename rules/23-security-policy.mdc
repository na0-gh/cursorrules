---
alwaysApply: true
---
Description: OWASP Top 10および業界標準に基づくセキュアコーディングのガイドラインです。認証、認可、データ保護、Supabaseセキュリティなど、全てのセキュリティ関連の実装においてこのルールを遵守してください。

# 🔐 セキュリティポリシー (Security Policy)

## 1. 基本原則 (Core Principles)
- **Security First**: コードを書く際は常に「これは安全か？」を自問してください。利便性よりもセキュリティを優先します。
- **最小権限の原則 (Least Privilege)**: ユーザーやシステムには、業務遂行に必要な最小限の権限のみを付与してください。
- **Default Deny**: アクセス制御は「明示的に許可されたもの以外は全て拒否」を基本としてください。

## 2. 実装ガイドライン (Implementation Guidelines)

### 2.1 認証と認可 (Authentication & Authorization)
- **パスワード管理**: パスワードを平文で保存することは厳禁です。BcryptやArgon2などの強力なハッシュアルゴリズムを使用してください（Supabase Authを使用する場合は自動的に処理されます）。
- **セッション管理**: セッションIDやトークンは安全に生成・管理し、HttpOnly/Secure属性を付与したCookieまたは適切なストレージに保存してください。
- **アクセス制御**: APIエンドポイントやページへのアクセス時には、必ずユーザーの権限を確認してください。フロントエンドの表示制御だけでなく、バックエンドでの検証が必須です。

### 2.2 入力検証とサニタイズ (Input Validation & Sanitization)
- **全ての入力を疑う**: クライアントからの入力（フォーム、クエリパラメータ、ヘッダー等）は全て信頼できないものとして扱ってください。
- **バリデーション**: `zod` や `yup` 等のライブラリを使用し、型、長さ、形式を厳密に検証してください。
- **XSS対策 (Cross-Site Scripting)**:
    - React等のフレームワークのデフォルトのエスケープ機能を活用してください。
    - `dangerouslySetInnerHTML` の使用は原則禁止です。必要な場合は `DOMPurify` 等でサニタイズしてください。
- **SSRF対策 (Server-Side Request Forgery)**:
    - ユーザー入力に基づくURLへのリクエストを行う場合は、許可リスト（Allow-list）方式で検証してください。

### 2.3 データ保護と暗号化 (Data Protection)
- **通信の暗号化**: 全ての通信はHTTPSで行ってください。
- **機密情報の保存**: PII（個人特定情報）や機密データは、保存時に暗号化することを検討してください。
- **シークレット管理**: APIキーやDB接続文字列などの機密情報は、絶対にコード内にハードコードしないでください。`.env` ファイルと環境変数を使用し、Git管理対象外にしてください。

### 2.4 インジェクション対策 (Injection Prevention)
- **SQLインジェクション**:
    - 生のSQLクエリの構築（文字列連結）は禁止です。
    - 必ずプレースホルダ（パラメータ化クエリ）や、ORM/クエリビルダー（Supabase JS Client, Prisma等）を使用してください。
- **OSコマンドインジェクション**:
    - ユーザー入力をそのままシェルコマンドの引数として渡さないでください。

## 3. Supabaseセキュリティ特記 (Supabase Specifics)

### 3.1 RLS (Row Level Security) の徹底
- **全テーブル有効化**: 全てのテーブルで必ず RLS を有効 (`ENABLE ROW LEVEL SECURITY`) にしてください。
- **ポリシー設計**:
    - `anon` ロール（未認証）と `authenticated` ロール（認証済み）の権限を明確に分けてください。
    - 「自分のデータのみ読み書き可能」(`auth.uid() = user_id`) を基本パターンとしてください。
- **Service Role Key**:
    - `SERVICE_ROLE_KEY` はサーバーサイド（Edge Functions等）でのみ使用し、クライアントサイドには絶対に露出させないでください。

### 3.2 クライアントサイドの制限
- クライアント側（ブラウザ）からは `anon` キーのみを使用してください。
- データのフィルタリングはクライアント側だけでなく、RLSポリシーでも強制してください。

## 4. 依存関係の管理 (Dependency Management)
- 定期的に `npm audit` 等を実行し、既知の脆弱性を持つパッケージを特定・更新してください。
- 不要なパッケージは削除し、攻撃対象領域（Attack Surface）を最小限に抑えてください。
