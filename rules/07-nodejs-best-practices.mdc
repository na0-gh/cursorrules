---
alwaysApply: false
---
Description: Node.js (特にExpressなどのフレームワーク) を使ったサーバーサイド開発における、セキュリティ、エラーハンドリング、コード構成に関するベストプラクティスを定義します。

# 1. 環境変数で設定を外部化する
- **考え方**: データベースの接続情報、APIキー、ポート番号などの設定値は、絶対にコードに直接書き込んではいけません。これらは環境によって変わるものであり、セキュリティ上非常に危険です。
- **実践方法**:
    - `dotenv`ライブラリを使用し、プロジェクトルートに`.env`ファイルを作成して機密情報を記述します。
    - `.gitignore`ファイルに`.env`を必ず追加し、Gitリポジトリにコミットされないようにします。
    - コード中では`process.env.YOUR_VARIABLE_NAME`の形でアクセスします。
- **AIへの指示**: 「このコードにハードコードされているデータベースのパスワードを、`.env`ファイルを使うようにリファクタリングしてほしい。」

# 2. エラーハンドリングを徹底する
- **考え方**: サーバーサイドのアプリケーションは、予期せぬエラーでクラッシュしてはいけません。非同期処理のエラーを確実にキャッチし、一元的に処理する仕組みが不可欠です。
- **実践方法**:
    - 全ての非同期処理（DBアクセス、API呼び出しなど）は`try...catch`ブロックで囲みます。
    - Expressなどのフレームワークでは、ルートハンドラの最後にエラーハンドリングミドルウェアを定義し、`next(error)`でエラーを集約します。
    - ユーザーに返すエラーメッセージには、スタックトレースなどの詳細な内部情報を含めないようにします。
- **AIへの指示**: 「このExpressのルートハンドラに、非同期処理のエラーをキャッチしてエラーハンドリングミドルウェアに渡す、堅牢なエラー処理を追加してほしい。」

# 3. 非同期処理は `async/await` で統一する
- **考え方**: Node.jsの核心は非同期処理です。コールバックや`Promise.then()`も使えますが、`async/await`構文を使うことで、同期処理のように直線的で読みやすいコードを書くことができます。特別な理由がない限り、`async/await`で統一しましょう。
- **AIへの指示**: 「この`Promise.then().catch()`を使っているコード、もっと読みやすいように`async/await`と`try...catch`を使って書き直して。」

# 4. モジュールはES Modules (`import`/`export`) を使う
- **考え方**: 昔ながらの`require`/`module.exports` (CommonJS) よりも、モダンな`import`/`export` (ES Modules) の方が、静的解析がしやすく、Tree Shaking（不要なコードの削除）などの恩恵も受けられます。`package.json`に`"type": "module"`を追加して、ES Modulesを使いましょう。
- **AIへの指示**: 「このプロジェクトを、CommonJSからES Modulesに移行したい。`require`を`import`に書き換えるのを手伝ってほしい。」