---
alwaysApply: true
description: サブエージェントの自動使用基準（いつ使う/使わない）を定義します。モデル選択とコンテキスト最適化の観点を含みます。
globs: []
---
# 44. サブエージェント自動使用ルール

## 目的
- 会話文脈から「サブエージェントを使うべきか」を自動判断する。
- ユーザーは承認/否認だけで進行できるようにする。
- **コンテキスト最適化**: `46-context-optimization-and-model-selection.mdc` に従い、**品質/トークン比の最大化**を最優先にする。トークン節約が目的ではなく、トークンあたりの成果品質を最大化する。

## 使うべき時（自動で起動）

**モデル選択**: `46-context-optimization-and-model-selection.mdc` に従い、タスクの性質に応じて最適なモデルを自動選択してください。

1. **探索が必要な時**
   - どこに実装があるか不明で、複数候補を調べる必要がある
   - 例: 「認証はどこで実装されている？」など
   - **推奨モデル**: `fast` または `explore` サブエージェント（迅速性が重要）
2. **広範囲/並列調査が有効な時**
   - 異なるディレクトリを並列で調べる必要がある
   - **推奨モデル**: `fast` + 並列実行（コンテキスト節約）
3. **長時間リサーチ・情報整理が必要な時**
   - 大きなファイル群の要約、仕様の比較など
   - **推奨モデル**: `fast` サブエージェント（メインコンテキストを節約）
4. **役割分担が有効な時**
   - 探索 → 実装、レビュー → 修正など、明確な役割分担ができる
   - **推奨モデル**: `fast` サブエージェント（探索/レビュー）+ `medium` メインエージェント（実装/修正）

## 使わない時（メインで対応）

**モデル選択**: タスクが単純な場合は、サブエージェントを使わずメインエージェントで対応してください。

1. **単一ファイル/単一シンボルの特定**
   - 例: 既知ファイルの編集、特定関数の検索
   - **推奨モデル**: `medium`（正確性が必要）
2. **軽量タスク**
   - 例: 1〜2ファイルの小修正、簡単な設定変更
   - **推奨モデル**: `fast` または `medium`（迅速性と正確性のバランス）
3. **即時判断が必要**
   - 例: すぐに実行できるコマンドや短い修正
   - **推奨モデル**: `fast`（迅速性が最優先）

## 運用ルール
- 自動判別の結果は `43-auto-skill-routing.mdc` の承認ゲートに従って提示する。
- サブエージェントの出力は要点だけに要約して返す。
- **コンテキスト最適化**: サブエージェントに渡すコンテキストもリスクベースで決定する。LOW RISKならdiff/Scanのみ、MEDIUM RISKならTargeted Deep Read、HIGH RISKならFull Read Allowed。必要なファイルのみを指定し、範囲指定（`offset`/`limit`）を活用する。

## モデル選択と役割分担

**原則**: ユーザーはモデルを選ばない。AIがタスクの性質に応じて最適なモデルを自動選択する。

### 役割分担のパターン

1. **探索 → 実装**
   - `fast`/`explore` サブエージェント: コードベースを探索し、実装箇所を特定
   - `medium` メインエージェント: 探索結果を基に実装を実行

2. **レビュー → 修正**
   - `fast` サブエージェント: コードをレビューし、問題箇所を特定
   - `medium` メインエージェント: レビュー結果を基に修正を実行

3. **調査 → 設計 → 実装**
   - `fast`/`explore` サブエージェント: 要件や既存実装を調査
   - `medium` サブエージェント: 調査結果を基に設計を立案
   - `medium`/`large` メインエージェント: 設計を基に実装を実行

詳細は `46-context-optimization-and-model-selection.mdc` を参照してください。

## 参考
- 探索・並列調査は `explore` サブエージェントを優先
- コンテキスト最適化: `46-context-optimization-and-model-selection.mdc`
